# æœ¬åœ°å¼€å‘ç¯å¢ƒæµ‹è¯•ä»˜è´¹åŠŸèƒ½å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­æµ‹è¯• Aviate AI çš„ä»˜è´¹åŠŸèƒ½ï¼ˆä¼šå‘˜è®¢é˜…ç³»ç»Ÿï¼‰ã€‚

## ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
3. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
4. [æµ‹è¯•æ–¹æ³•](#æµ‹è¯•æ–¹æ³•)
5. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### ä»˜è´¹åŠŸèƒ½ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Native  â”‚         â”‚   Backend API    â”‚         â”‚  Apple Store    â”‚
â”‚   (smart-atc)   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  (atc-server)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Servers       â”‚
â”‚                 â”‚         â”‚                  â”‚         â”‚                 â”‚
â”‚  - IAPè´­ä¹°æµç¨‹  â”‚         â”‚  - æ”¶æ®éªŒè¯      â”‚         â”‚  - æ”¶æ®éªŒè¯     â”‚
â”‚  - ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º â”‚         â”‚  - ä¼šå‘˜ç®¡ç†      â”‚         â”‚  - è®¢é˜…ç®¡ç†     â”‚
â”‚  - åŠŸèƒ½æƒé™æ£€æŸ¥ â”‚         â”‚  - ä½¿ç”¨é‡ç»Ÿè®¡    â”‚         â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  PostgreSQL  â”‚
                 â”‚   Database   â”‚
                 â”‚              â”‚
                 â”‚ - membershipsâ”‚
                 â”‚ - payments   â”‚
                 â”‚ - usage_recs â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼šå‘˜ç­‰çº§

- **FREE**: å…è´¹ç”¨æˆ·
  - åªèƒ½è®¿é—® KSJC æœºåœºçš„ Live ATC
  - åªèƒ½ä½¿ç”¨ traffic-pattern è®­ç»ƒæ¨¡å¼
  - å½•éŸ³åˆ†æé™åˆ¶ï¼š1æ¬¡ï¼ˆä¸€æ¬¡æ€§é…é¢ï¼‰
  - è®­ç»ƒä¼šè¯ï¼šæ— é™åˆ¶

- **PREMIUM**: ä»˜è´¹ç”¨æˆ·
  - è®¿é—®æ‰€æœ‰æœºåœºçš„ Live ATC
  - è®¿é—®æ‰€æœ‰è®­ç»ƒæ¨¡å¼
  - æ— é™å½•éŸ³åˆ†æ
  - æ— é™è®­ç»ƒä¼šè¯

### äº§å“ ID

```typescript
// æœˆä»˜è®¢é˜…
'com.aviateai.premium.monthly'  // $14.99/æœˆ

// å¹´ä»˜è®¢é˜…
'com.aviateai.premium.yearly'   // $69.99/å¹´ (èŠ‚çœ60%)

// å…¼å®¹æ—§ç‰ˆæœ¬
'com.aviateai.golden.monthly'   // å·²åºŸå¼ƒï¼Œä½†ä»æ”¯æŒ
'com.aviateai.golden.yearly'    // å·²åºŸå¼ƒï¼Œä½†ä»æ”¯æŒ
```

---

## å‰ç½®å‡†å¤‡

### 1. å¼€å‘ç¯å¢ƒè¦æ±‚

- **macOS** (ç”¨äº iOS å¼€å‘)
- **Node.js** >= 18
- **PostgreSQL** >= 14
- **Xcode** (æœ€æ–°ç‰ˆæœ¬)
- **iOS çœŸæœºè®¾å¤‡** (IAP ä¸èƒ½åœ¨æ¨¡æ‹Ÿå™¨ä¸Šæµ‹è¯•)
- **Apple Developer Account** (éœ€è¦ä»˜è´¹è´¦å·)

### 2. Apple é…ç½®

#### 2.1 App Store Connect é…ç½®

1. ç™»å½• [App Store Connect](https://appstoreconnect.apple.com/)
2. è¿›å…¥ä½ çš„ App
3. é…ç½® **In-App Purchases**:
   - åˆ›å»ºä¸¤ä¸ªè‡ªåŠ¨ç»­æœŸè®¢é˜…äº§å“ï¼š
     - `com.aviateai.premium.monthly`
     - `com.aviateai.premium.yearly`
   - ç¡®ä¿äº§å“çŠ¶æ€ä¸º **"Ready to Submit"**

4. è·å– **App-Specific Shared Secret**:
   ```
   App Information â†’ App-Specific Shared Secret â†’ Generate
   ```
   ä¿å­˜è¿™ä¸ªå¯†é’¥ï¼Œåé¢ä¼šç”¨åˆ°ã€‚

#### 2.2 åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦å·

1. åœ¨ App Store Connect ä¸­:
   ```
   Users and Access â†’ Sandbox Testers â†’ Add Tester
   ```

2. åˆ›å»ºæµ‹è¯•è´¦å·:
   ```
   Email: test@example.com (å¯ä»¥æ˜¯è™šæ‹Ÿé‚®ç®±)
   Password: è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç 
   Country: United States
   ```

3. **é‡è¦**: ä¸è¦åœ¨çœŸå®è®¾å¤‡ä¸Šç™»å½•è¿™ä¸ªè´¦å·çš„ iCloudï¼

---

## ç¯å¢ƒé…ç½®

### 1. åç«¯é…ç½® (atc-server)

#### 1.1 ç¯å¢ƒå˜é‡é…ç½®

ç¼–è¾‘ `.env.development`:

```bash
# æ•°æ®åº“è¿æ¥
DATABASE_URL="postgresql://postgres:mysecretpassword@localhost:5432/smart-atc?schema=public"

# JWT å¯†é’¥
JWT_SECRET="UD5dDT3w0QrKacvxoTmyJ8gjJq/KdfkCD4j7P27iYBw="

# Apple IAP é…ç½®
APPLE_SHARED_SECRET=261ae73c4b594a878b5e5561e4fca386  # ä» App Store Connect è·å–

# Apple ç™»å½•é…ç½®
APPLE_CLIENT_ID=com.jujubecamp.aviateai

# å…¶ä»–é…ç½®
PORT=3000
NODE_ENV=development
LOG_LEVEL=info

# AWS S3 (ç”¨äºå½•éŸ³åŠŸèƒ½)
AWS_REGION=us-west-2
AWS_S3_AUDIO_BUCKET=aviate-ai-public
AWS_S3_AUDIO_PREFIX=cockpit/audio
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret
```

#### 1.2 æ•°æ®åº“åˆå§‹åŒ–

```bash
cd atc-server

# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨ PostgreSQL (å¦‚æœä½¿ç”¨ Docker)
docker-compose up -d postgres

# è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm prisma migrate dev

# åˆå§‹åŒ–ä¼šå‘˜è®¡åˆ’æ•°æ®
pnpm prisma db seed  # å¦‚æœæœ‰ seed è„šæœ¬
```

å¦‚æœæ²¡æœ‰ seed è„šæœ¬ï¼Œæ‰‹åŠ¨æ’å…¥ä¼šå‘˜è®¡åˆ’ï¼š

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
psql postgresql://postgres:mysecretpassword@localhost:5432/smart-atc

-- æ’å…¥ Premium ä¼šå‘˜è®¡åˆ’
INSERT INTO membership_plans (
  id, tier, monthly_price, yearly_price, yearly_discount,
  monthly_product_id, yearly_product_id, is_active
) VALUES (
  'cuid_premium_plan',
  'PREMIUM',
  14.99,
  69.99,
  0.60,
  'com.aviateai.premium.monthly',
  'com.aviateai.premium.yearly',
  true
);
```

#### 1.3 å¯åŠ¨åç«¯æœåŠ¡

```bash
cd atc-server
pnpm dev
```

éªŒè¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼š
```bash
curl http://localhost:3000/api/v1/version
```

### 2. å‰ç«¯é…ç½® (smart-atc)

#### 2.1 ç¯å¢ƒå˜é‡é…ç½®

ç¼–è¾‘ `app.config.js`:

```javascript
// ç¡®ä¿ development ç¯å¢ƒæŒ‡å‘ä½ çš„æœ¬åœ° IP
const localIpAddress = getLocalIpAddress(); // è‡ªåŠ¨æ£€æµ‹

module.exports = {
  expo: {
    // ... å…¶ä»–é…ç½®
    extra: {
      // å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ° IPï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ AWS
      apiBaseUrl: env === 'development' 
        ? `http://${localIpAddress}:3000/api/v1` 
        : 'http://atc-server-alb-473487194.us-west-2.elb.amazonaws.com:3000/api/v1',
      env: env,
    },
  },
};
```

#### 2.2 è·å–æœ¬åœ° IP åœ°å€

```bash
# macOS
ipconfig getifaddr en0  # WiFi
# æˆ–
ifconfig | grep "inet " | grep -v 127.0.0.1

# ç¤ºä¾‹è¾“å‡º: 192.168.1.100
```

#### 2.3 iOS é…ç½®

ç¡®ä¿ `app.config.js` ä¸­å…è®¸æœ¬åœ° HTTP è¿æ¥ï¼š

```javascript
ios: {
  infoPlist: {
    NSAppTransportSecurity: {
      NSAllowsArbitraryLoads: true,
      NSExceptionDomains: {
        [localIpAddress]: {
          NSExceptionAllowsInsecureHTTPLoads: true,
          NSIncludesSubdomains: true,
        },
      },
    },
  },
},
```

#### 2.4 æ„å»ºå¹¶å®‰è£…åˆ°çœŸæœº

```bash
cd smart-atc

# å®‰è£…ä¾èµ–
npm install

# é¢„æ„å»º iOS
npx expo prebuild --platform ios

# æ‰“å¼€ Xcode é¡¹ç›®
open ios/aviateai.xcworkspace

# åœ¨ Xcode ä¸­:
# 1. é€‰æ‹©ä½ çš„å¼€å‘å›¢é˜Ÿ (Signing & Capabilities)
# 2. è¿æ¥ iOS çœŸæœº
# 3. é€‰æ‹©çœŸæœºä½œä¸ºç›®æ ‡è®¾å¤‡
# 4. ç‚¹å‡» Run (âŒ˜R)
```

---

## æµ‹è¯•æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Apple æ²™ç›’ç¯å¢ƒæµ‹è¯•ï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€æ¥è¿‘çœŸå®åœºæ™¯çš„æµ‹è¯•æ–¹æ³•ã€‚

#### æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•è®¾å¤‡

1. åœ¨ iOS è®¾å¤‡ä¸Šï¼Œ**é€€å‡º App Store è´¦å·**:
   ```
   Settings â†’ [Your Name] â†’ Media & Purchases â†’ Sign Out
   ```
   
2. **ä¸è¦**åœ¨ Settings â†’ Apple ID ä¸­é€€å‡ºï¼ˆä¿ç•™ iCloud ç™»å½•ï¼‰

#### æ­¥éª¤ 2: ç™»å½•åº”ç”¨å¹¶æµ‹è¯•è´­ä¹°

1. æ‰“å¼€ Aviate AI åº”ç”¨
2. ä½¿ç”¨ Apple ç™»å½•æˆ–é‚®ç®±æ³¨å†Œ
3. è¿›å…¥ä¼šå‘˜è´­ä¹°é¡µé¢ï¼ˆç‚¹å‡»ä»»ä½•éœ€è¦ä»˜è´¹çš„åŠŸèƒ½ï¼‰
4. ç‚¹å‡» "Subscribe Monthly" æˆ– "Subscribe Yearly"
5. ç³»ç»Ÿä¼šæç¤ºç™»å½• App Store
6. ä½¿ç”¨ä½ çš„**æ²™ç›’æµ‹è¯•è´¦å·**ç™»å½•
7. ç¡®è®¤è´­ä¹°ï¼ˆæ²™ç›’ç¯å¢ƒä¸ä¼šçœŸå®æ‰£è´¹ï¼‰

#### æ­¥éª¤ 3: éªŒè¯è´­ä¹°æµç¨‹

è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š

**å‰ç«¯æ—¥å¿—** (React Native Debugger):
```
[MembershipModal] ğŸ”Œ Connecting to Apple IAP...
[MembershipModal] âœ… Connected: true
[MembershipModal] ğŸ“¦ Requesting products: ["com.aviateai.premium.monthly", "com.aviateai.premium.yearly"]
[MembershipModal] ğŸ“¥ Products received: 2
[MembershipModal] ğŸ’° Products from Apple: [...]
[MembershipModal] ğŸ”„ Updating prices from Apple...
[MembershipModal] âœ… Prices updated successfully
```

**åç«¯æ—¥å¿—** (Terminal):
```
[MembershipController] Verifying receipt with Apple
[AppleReceipt] Receipt is from sandbox, retrying with sandbox URL
[AppleReceipt] Verification response: { status: 0, environment: 'Sandbox' }
[AppleReceipt] Receipt verified successfully
[MembershipService] Recording payment
[MembershipService] Updating membership
```

#### æ­¥éª¤ 4: éªŒè¯ä¼šå‘˜çŠ¶æ€

1. è´­ä¹°æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°æˆåŠŸæç¤º
2. è¿”å›ä¸»ç•Œé¢ï¼Œæ£€æŸ¥ï¼š
   - æ‰€æœ‰æœºåœºçš„ Live ATC éƒ½å¯ä»¥è®¿é—®
   - æ‰€æœ‰è®­ç»ƒæ¨¡å¼éƒ½å¯ä»¥è®¿é—®
   - å½•éŸ³åˆ†ææ¬¡æ•°æ˜¾ç¤ºä¸º "Unlimited"

3. é€šè¿‡ API éªŒè¯ï¼š
```bash
# è·å–ç”¨æˆ·çš„ access token (ä»åº”ç”¨æ—¥å¿—æˆ–è°ƒè¯•å™¨ä¸­)
TOKEN="your_access_token_here"

# æŸ¥è¯¢ä¼šå‘˜çŠ¶æ€
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v1/membership

# é¢„æœŸå“åº”:
{
  "membership": {
    "tier": "PREMIUM",
    "expiresAt": "2025-12-13T00:00:00.000Z",
    "isActive": true
  },
  "limits": {
    "maxTrainingSessions": null,
    "maxRecordingUploads": null,
    "trainingSessionsUsed": 0,
    "recordingUploadsUsed": 0,
    "trainingSessionsResetAt": null,
    "recordingUploadsResetAt": null
  }
}
```

#### æ­¥éª¤ 5: æµ‹è¯•æ¢å¤è´­ä¹°

1. åœ¨åº”ç”¨ä¸­ç‚¹å‡» "Restore Purchases"
2. ç³»ç»Ÿä¼šé‡æ–°éªŒè¯ä½ çš„è®¢é˜…
3. ä¼šå‘˜çŠ¶æ€åº”è¯¥ä¿æŒä¸º PREMIUM

#### æ­¥éª¤ 6: æµ‹è¯•è®¢é˜…è¿‡æœŸ

æ²™ç›’ç¯å¢ƒä¸­ï¼Œè®¢é˜…ä¼šå¿«é€Ÿè¿‡æœŸï¼š
- 1ä¸ªæœˆè®¢é˜… â†’ 5åˆ†é’Ÿåè¿‡æœŸ
- 1å¹´è®¢é˜… â†’ 1å°æ—¶åè¿‡æœŸ

ç­‰å¾…è¿‡æœŸåï¼š
1. é‡å¯åº”ç”¨
2. ä¼šå‘˜çŠ¶æ€åº”è¯¥è‡ªåŠ¨é™çº§ä¸º FREE
3. ä»˜è´¹åŠŸèƒ½åº”è¯¥è¢«é™åˆ¶

---

### æ–¹æ³•äºŒï¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“æµ‹è¯•ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰

é€‚ç”¨äºå¿«é€Ÿæµ‹è¯•åŠŸèƒ½é€»è¾‘ï¼Œä¸æµ‹è¯•çœŸå®æ”¯ä»˜æµç¨‹ã€‚

#### æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•ç”¨æˆ·

```bash
# åœ¨åº”ç”¨ä¸­æ³¨å†Œä¸€ä¸ªæµ‹è¯•è´¦å·
# æˆ–ä½¿ç”¨ç°æœ‰è´¦å·
```

#### æ­¥éª¤ 2: æ‰‹åŠ¨å‡çº§ä¸º Premium

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
psql postgresql://postgres:mysecretpassword@localhost:5432/smart-atc

-- æŸ¥æ‰¾ä½ çš„ç”¨æˆ· ID
SELECT id, email, display_name FROM users WHERE email = 'your_test_email@example.com';

-- å‡è®¾ç”¨æˆ· ID æ˜¯ 'clxxx123'
-- åˆ›å»ºæˆ–æ›´æ–°ä¼šå‘˜è®°å½•
INSERT INTO memberships (id, user_id, tier, expires_at, created_at, updated_at)
VALUES (
  'membership_test_001',
  'clxxx123',  -- æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ· ID
  'PREMIUM',
  NOW() + INTERVAL '30 days',  -- 30å¤©åè¿‡æœŸ
  NOW(),
  NOW()
)
ON CONFLICT (user_id) DO UPDATE SET
  tier = 'PREMIUM',
  expires_at = NOW() + INTERVAL '30 days',
  updated_at = NOW();
```

#### æ­¥éª¤ 3: éªŒè¯ä¼šå‘˜çŠ¶æ€

é‡å¯åº”ç”¨ï¼Œæ£€æŸ¥ï¼š
- ä¼šå‘˜çŠ¶æ€æ˜¾ç¤ºä¸º Premium
- æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥è®¿é—®

#### æ­¥éª¤ 4: æµ‹è¯•é™çº§

```sql
-- å°†ä¼šå‘˜é™çº§ä¸º FREE
UPDATE memberships 
SET tier = 'FREE', expires_at = NULL, updated_at = NOW()
WHERE user_id = 'clxxx123';
```

é‡å¯åº”ç”¨ï¼Œæ£€æŸ¥ï¼š
- ä¼šå‘˜çŠ¶æ€æ˜¾ç¤ºä¸º Free
- ä»˜è´¹åŠŸèƒ½è¢«é™åˆ¶

---

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ API ç›´æ¥æµ‹è¯•ï¼ˆåç«¯æµ‹è¯•ï¼‰

é€‚ç”¨äºæµ‹è¯•åç«¯é€»è¾‘ï¼Œä¸æ¶‰åŠå‰ç«¯ã€‚

#### æ­¥éª¤ 1: è·å–è®¿é—®ä»¤ç‰Œ

```bash
# æ³¨å†Œæˆ–ç™»å½•
curl -X POST http://localhost:3000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPassword123!",
    "displayName": "Test User"
  }'

# å“åº”ä¸­åŒ…å« accessToken
```

#### æ­¥éª¤ 2: æµ‹è¯•ä¼šå‘˜ API

```bash
TOKEN="your_access_token"

# 1. è·å–ä¼šå‘˜è®¡åˆ’
curl http://localhost:3000/api/v1/membership/plans

# 2. è·å–å½“å‰ä¼šå‘˜çŠ¶æ€
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v1/membership

# 3. è·å–ä½¿ç”¨é™åˆ¶
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v1/membership/limits

# 4. æ£€æŸ¥åŠŸèƒ½è®¿é—®æƒé™
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:3000/api/v1/membership/check-access?feature=liveatc&icao=KSFO"

# 5. è·å–æ”¯ä»˜å†å²
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/v1/membership/history
```

#### æ­¥éª¤ 3: æ¨¡æ‹Ÿæ”¶æ®éªŒè¯ï¼ˆéœ€è¦çœŸå®æ”¶æ®ï¼‰

```bash
# è¿™éœ€è¦ä»çœŸå®çš„ iOS è´­ä¹°ä¸­è·å– receiptData
curl -X POST http://localhost:3000/api/v1/membership/verify-payment \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "transactionId": "1000000123456789",
    "productId": "com.aviateai.premium.monthly",
    "receiptData": "base64_encoded_receipt_data_here"
  }'
```

---

## æµ‹è¯•åœºæ™¯æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

- [ ] **å…è´¹ç”¨æˆ·é™åˆ¶**
  - [ ] åªèƒ½è®¿é—® KSJC æœºåœº
  - [ ] åªèƒ½ä½¿ç”¨ traffic-pattern æ¨¡å¼
  - [ ] å½•éŸ³åˆ†æé™åˆ¶ä¸º 1 æ¬¡
  - [ ] å°è¯•è®¿é—®ä»˜è´¹åŠŸèƒ½æ—¶æ˜¾ç¤ºå‡çº§æç¤º

- [ ] **è´­ä¹°æµç¨‹**
  - [ ] æ˜¾ç¤ºæ­£ç¡®çš„ä»·æ ¼ï¼ˆä» Apple è·å–ï¼‰
  - [ ] æœˆä»˜è´­ä¹°æˆåŠŸ
  - [ ] å¹´ä»˜è´­ä¹°æˆåŠŸ
  - [ ] è´­ä¹°åä¼šå‘˜çŠ¶æ€ç«‹å³æ›´æ–°
  - [ ] è´­ä¹°åæ‰€æœ‰åŠŸèƒ½è§£é”

- [ ] **Premium ç”¨æˆ·æƒé™**
  - [ ] å¯ä»¥è®¿é—®æ‰€æœ‰æœºåœº
  - [ ] å¯ä»¥ä½¿ç”¨æ‰€æœ‰è®­ç»ƒæ¨¡å¼
  - [ ] å½•éŸ³åˆ†ææ˜¾ç¤º "Unlimited"
  - [ ] è®­ç»ƒä¼šè¯æ— é™åˆ¶

- [ ] **æ¢å¤è´­ä¹°**
  - [ ] æ¢å¤è´­ä¹°æˆåŠŸ
  - [ ] ä¼šå‘˜çŠ¶æ€æ­£ç¡®æ¢å¤
  - [ ] è·¨è®¾å¤‡æ¢å¤ï¼ˆä½¿ç”¨åŒä¸€ Apple IDï¼‰

- [ ] **è®¢é˜…è¿‡æœŸ**
  - [ ] è¿‡æœŸåè‡ªåŠ¨é™çº§ä¸º FREE
  - [ ] ä»˜è´¹åŠŸèƒ½è¢«é™åˆ¶
  - [ ] æ˜¾ç¤ºç»­è´¹æç¤º

### è¾¹ç¼˜æƒ…å†µæµ‹è¯•

- [ ] **ç½‘ç»œé—®é¢˜**
  - [ ] è´­ä¹°æ—¶ç½‘ç»œæ–­å¼€ â†’ æœ¬åœ°ä¿å­˜ï¼Œç¨åé‡è¯•
  - [ ] éªŒè¯æ—¶ç½‘ç»œæ–­å¼€ â†’ æ˜¾ç¤ºé”™è¯¯ï¼Œå…è®¸é‡è¯•
  - [ ] ç¦»çº¿æ—¶æ˜¾ç¤ºç¼“å­˜çš„ä¼šå‘˜çŠ¶æ€

- [ ] **é‡å¤è´­ä¹°**
  - [ ] ç›¸åŒ transactionId ä¸ä¼šé‡å¤å¤„ç†
  - [ ] æ˜¾ç¤ºå·²è´­ä¹°æç¤º

- [ ] **äº§å“ ID ä¸åŒ¹é…**
  - [ ] åç«¯æ‹’ç»æ— æ•ˆçš„äº§å“ ID
  - [ ] æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

- [ ] **æ”¶æ®éªŒè¯å¤±è´¥**
  - [ ] Apple è¿”å›é”™è¯¯çŠ¶æ€ç 
  - [ ] æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
  - [ ] å…è®¸ç”¨æˆ·é‡è¯•

### æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

- [ ] **ä½¿ç”¨é‡ç»Ÿè®¡**
  - [ ] å½•éŸ³åˆ†ææ¬¡æ•°æ­£ç¡®é€’å¢
  - [ ] è®­ç»ƒä¼šè¯æ¬¡æ•°æ­£ç¡®ç»Ÿè®¡
  - [ ] Premium ç”¨æˆ·ä¸å—é™åˆ¶

- [ ] **å¹¶å‘è´­ä¹°**
  - [ ] å¤šä¸ªè®¾å¤‡åŒæ—¶è´­ä¹° â†’ åªè®°å½•ä¸€æ¬¡
  - [ ] æ•°æ®åº“äº‹åŠ¡æ­£ç¡®å¤„ç†

- [ ] **æ”¯ä»˜å†å²**
  - [ ] æ‰€æœ‰æ”¯ä»˜è®°å½•éƒ½è¢«ä¿å­˜
  - [ ] æ”¯ä»˜å†å²æŒ‰æ—¶é—´æ’åº
  - [ ] æ˜¾ç¤ºæ­£ç¡®çš„é‡‘é¢å’ŒçŠ¶æ€

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ— æ³•è¿æ¥åˆ°åç«¯

**ç—‡çŠ¶**: å‰ç«¯æ— æ³•è°ƒç”¨åç«¯ API

**æ£€æŸ¥**:
```bash
# 1. ç¡®è®¤åç«¯æ­£åœ¨è¿è¡Œ
curl http://localhost:3000/api/v1/version

# 2. æ£€æŸ¥æœ¬åœ° IP åœ°å€
ipconfig getifaddr en0

# 3. ç¡®è®¤ app.config.js ä¸­çš„ IP æ­£ç¡®
# 4. ç¡®è®¤ iOS å…è®¸ HTTP è¿æ¥ï¼ˆNSAppTransportSecurityï¼‰
```

**è§£å†³**:
- ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ WiFi ç½‘ç»œ
- å…³é—­é˜²ç«å¢™æˆ–æ·»åŠ ä¾‹å¤–
- ä½¿ç”¨æ­£ç¡®çš„æœ¬åœ° IPï¼ˆä¸æ˜¯ localhostï¼‰

### 2. Apple IAP æ— æ³•åŠ è½½äº§å“

**ç—‡çŠ¶**: `Products received: 0`

**æ£€æŸ¥**:
```
[MembershipModal] âš ï¸ No products returned from Apple!
[MembershipModal] ğŸ’¡ Make sure:
[MembershipModal]   1. Running on a real iOS device (not simulator)
[MembershipModal]   2. Products exist in App Store Connect
[MembershipModal]   3. Product IDs match exactly
[MembershipModal]   4. Products are in "Ready to Submit" state
```

**è§£å†³**:
1. ç¡®è®¤åœ¨çœŸæœºä¸Šæµ‹è¯•ï¼ˆä¸æ˜¯æ¨¡æ‹Ÿå™¨ï¼‰
2. æ£€æŸ¥ App Store Connect ä¸­çš„äº§å“é…ç½®
3. ç¡®è®¤äº§å“ ID å®Œå…¨åŒ¹é…ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
4. ç­‰å¾…å‡ åˆ†é’Ÿï¼ˆApple æœåŠ¡å™¨åŒæ­¥éœ€è¦æ—¶é—´ï¼‰
5. å°è¯•é‡å¯åº”ç”¨

### 3. æ”¶æ®éªŒè¯å¤±è´¥

**ç—‡çŠ¶**: `Receipt could not be authenticated (status 21003)`

**æ£€æŸ¥**:
```bash
# æ£€æŸ¥ APPLE_SHARED_SECRET æ˜¯å¦æ­£ç¡®
grep APPLE_SHARED_SECRET atc-server/.env.development
```

**è§£å†³**:
1. ç¡®è®¤ `.env.development` ä¸­çš„ `APPLE_SHARED_SECRET` æ­£ç¡®
2. ç¡®è®¤ä½¿ç”¨çš„æ˜¯ App-Specific Shared Secretï¼ˆä¸æ˜¯ Master Shared Secretï¼‰
3. æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„ç¯å¢ƒï¼ˆSandbox vs Productionï¼‰

### 4. æ²™ç›’è´¦å·é—®é¢˜

**ç—‡çŠ¶**: æ— æ³•ä½¿ç”¨æ²™ç›’è´¦å·è´­ä¹°

**è§£å†³**:
1. ç¡®ä¿åœ¨ Settings â†’ App Store ä¸­**æ²¡æœ‰**ç™»å½•ä»»ä½•è´¦å·
2. åªåœ¨åº”ç”¨å†…è´­ä¹°æ—¶ç™»å½•æ²™ç›’è´¦å·
3. ä¸è¦åœ¨ iCloud ä¸­ç™»å½•æ²™ç›’è´¦å·
4. å¦‚æœæ²™ç›’è´¦å·è¢«é”å®šï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„

### 5. æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `DATABASE_URL validation error`

**æ£€æŸ¥**:
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql postgresql://postgres:mysecretpassword@localhost:5432/smart-atc -c "SELECT 1"

# æ£€æŸ¥ PostgreSQL æ˜¯å¦è¿è¡Œ
docker ps | grep postgres
# æˆ–
pg_isready
```

**è§£å†³**:
1. å¯åŠ¨ PostgreSQL: `docker-compose up -d postgres`
2. ç¡®è®¤ `.env.development` ä¸­çš„ `DATABASE_URL` æ­£ç¡®
3. è¿è¡Œè¿ç§»: `pnpm prisma migrate dev`

### 6. è´­ä¹°åä¼šå‘˜çŠ¶æ€æœªæ›´æ–°

**ç—‡çŠ¶**: è´­ä¹°æˆåŠŸä½†ä»æ˜¾ç¤º FREE

**æ£€æŸ¥**:
```sql
-- æŸ¥çœ‹æ•°æ®åº“ä¸­çš„ä¼šå‘˜è®°å½•
SELECT * FROM memberships WHERE user_id = 'your_user_id';

-- æŸ¥çœ‹æ”¯ä»˜è®°å½•
SELECT * FROM payments WHERE user_id = 'your_user_id' ORDER BY created_at DESC;
```

**è§£å†³**:
1. æ£€æŸ¥åç«¯æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
2. ç¡®è®¤æ”¶æ®éªŒè¯æˆåŠŸ
3. æ‰‹åŠ¨åˆ·æ–°åº”ç”¨ï¼ˆä¸‹æ‹‰åˆ·æ–°ï¼‰
4. é‡æ–°ç™»å½•

### 7. ä½¿ç”¨é‡ç»Ÿè®¡ä¸æ­£ç¡®

**ç—‡çŠ¶**: å½•éŸ³åˆ†ææ¬¡æ•°æ˜¾ç¤ºé”™è¯¯

**æ£€æŸ¥**:
```sql
-- æŸ¥çœ‹ä½¿ç”¨è®°å½•
SELECT * FROM usage_records WHERE user_id = 'your_user_id';
```

**è§£å†³**:
1. æ£€æŸ¥ `MembershipService.tryRecordUsageForAnalysis()` çš„è°ƒç”¨
2. ç¡®è®¤äº‹åŠ¡æ­£ç¡®æäº¤
3. æ‰‹åŠ¨é‡ç½®ä½¿ç”¨é‡ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰:
```sql
DELETE FROM usage_records WHERE user_id = 'your_user_id';
```

---

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

**åç«¯**:
```bash
# .env.development
LOG_LEVEL=debug
```

**å‰ç«¯**:
```javascript
// åœ¨ MembershipModal.tsx ä¸­å·²æœ‰è¯¦ç»†æ—¥å¿—
console.log('[MembershipModal] ...');
```

### 2. ä½¿ç”¨ React Native Debugger

```bash
# å®‰è£…
brew install --cask react-native-debugger

# å¯åŠ¨
open "rndebugger://set-debugger-loc?host=localhost&port=8081"

# åœ¨åº”ç”¨ä¸­å¯ç”¨è°ƒè¯•
# æ‘‡æ™ƒè®¾å¤‡ â†’ Debug â†’ Enable Remote JS Debugging
```

### 3. ç›‘æ§ç½‘ç»œè¯·æ±‚

åœ¨ React Native Debugger ä¸­æŸ¥çœ‹ Network æ ‡ç­¾ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰ API è¯·æ±‚ã€‚

### 4. æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€

```bash
# è¿æ¥åˆ°æ•°æ®åº“
psql postgresql://postgres:mysecretpassword@localhost:5432/smart-atc

# å¸¸ç”¨æŸ¥è¯¢
\dt                          # åˆ—å‡ºæ‰€æœ‰è¡¨
\d memberships               # æŸ¥çœ‹è¡¨ç»“æ„
SELECT * FROM memberships;   # æŸ¥çœ‹æ‰€æœ‰ä¼šå‘˜
SELECT * FROM payments;      # æŸ¥çœ‹æ‰€æœ‰æ”¯ä»˜
SELECT * FROM usage_records; # æŸ¥çœ‹ä½¿ç”¨è®°å½•
```

### 5. é‡ç½®æµ‹è¯•ç¯å¢ƒ

```bash
# æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®
psql postgresql://postgres:mysecretpassword@localhost:5432/smart-atc << EOF
DELETE FROM usage_records;
DELETE FROM payments;
DELETE FROM memberships;
EOF

# æˆ–å®Œå…¨é‡ç½®æ•°æ®åº“
cd atc-server
pnpm prisma migrate reset
```

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ³¨æ„äº‹é¡¹

å½“å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼š

1. **æ›´æ–°ç¯å¢ƒå˜é‡**:
   ```bash
   # .env.production
   APPLE_SHARED_SECRET=production_shared_secret
   NODE_ENV=production
   ```

2. **é…ç½® Apple Server Notifications**:
   - åœ¨ App Store Connect ä¸­è®¾ç½® webhook URL
   - æµ‹è¯• webhook æ¥æ”¶

3. **ç›‘æ§å’Œæ—¥å¿—**:
   - è®¾ç½®æ—¥å¿—èšåˆï¼ˆå¦‚ CloudWatchï¼‰
   - é…ç½®é”™è¯¯æŠ¥è­¦
   - ç›‘æ§æ”¯ä»˜æˆåŠŸç‡

4. **æ•°æ®å¤‡ä»½**:
   - å®šæœŸå¤‡ä»½æ•°æ®åº“
   - ä¿å­˜æ”¯ä»˜è®°å½•

5. **å®‰å…¨æ£€æŸ¥**:
   - ç¡®ä¿ HTTPS
   - éªŒè¯ JWT å¯†é’¥å¼ºåº¦
   - å®¡æŸ¥æƒé™æ£€æŸ¥é€»è¾‘

---

## ç›¸å…³æ–‡æ¡£

- [APPLE_IAP_SETUP.md](../APPLE_IAP_SETUP.md) - Apple IAP é…ç½®æŒ‡å—
- [API_ROUTES.md](../API_ROUTES.md) - API è·¯ç”±æ–‡æ¡£
- [membershipService.ts](../src/services/membershipService.ts) - ä¼šå‘˜æœåŠ¡ä»£ç 
- [MembershipModal.tsx](../../smart-atc/src/components/MembershipModal.tsx) - è´­ä¹°ç•Œé¢ä»£ç 

---

## æ€»ç»“

æœ¬åœ°æµ‹è¯•ä»˜è´¹åŠŸèƒ½çš„å…³é”®æ­¥éª¤ï¼š

1. âœ… é…ç½® Apple IAPï¼ˆäº§å“ã€æ²™ç›’è´¦å·ã€Shared Secretï¼‰
2. âœ… é…ç½®åç«¯ç¯å¢ƒï¼ˆæ•°æ®åº“ã€ç¯å¢ƒå˜é‡ï¼‰
3. âœ… é…ç½®å‰ç«¯ç¯å¢ƒï¼ˆæœ¬åœ° IPã€HTTP æƒé™ï¼‰
4. âœ… åœ¨çœŸæœºä¸Šæµ‹è¯•è´­ä¹°æµç¨‹
5. âœ… éªŒè¯ä¼šå‘˜çŠ¶æ€å’ŒåŠŸèƒ½æƒé™
6. âœ… æµ‹è¯•è¾¹ç¼˜æƒ…å†µå’Œé”™è¯¯å¤„ç†

é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰ç…§"å¸¸è§é—®é¢˜æ’æŸ¥"éƒ¨åˆ†é€æ­¥æ£€æŸ¥ã€‚

Good luck! ğŸš€
